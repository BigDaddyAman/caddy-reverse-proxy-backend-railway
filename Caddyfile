{
    admin off
}

:{$PORT:8080} {

    log {
        output stdout
        format console
    }

    header X-Caddy "active"

    # ========================
    # BAD BOT BLOCKING
    # ========================
    @badbots {
        header_regexp ua User-Agent (?i)(curl|wget|python|bot|crawler|spider|scan|scrapy|go-http-client|libwww-perl|java|php|perl|ruby)
    }
    respond @badbots 403

    # ========================
    # PATH SCAN BLOCKERS
    # ========================
    @xmlrpc path /xmlrpc.php
    respond @xmlrpc 403

    @rx_env path_regexp (?i)/?(.*/)?\.env
    respond @rx_env 403

    @rx_git path_regexp (?i)/?(.*/)?\.git
    respond @rx_git 403

    @rx_wpinc path_regexp (?i)/?(.*/)?wp-includes
    respond @rx_wpinc 403

    @rx_wplogin path_regexp (?i)/?(.*/)?wp-login\.php
    respond @rx_wplogin 403

    @rx_wpconfig path_regexp (?i)/?(.*/)?wp-config\.php
    respond @rx_wpconfig 403

    @rx_phpmy path_regexp (?i)/?(.*/)?phpmyadmin
    respond @rx_phpmy 403

    @rx_wlw path_regexp (?i)/?(.*/)?wlwmanifest\.xml
    respond @rx_wlw 403

    @rx_awsconfig path_regexp (?i)/?(.*/)?aws[-_.]?config\.js
    respond @rx_awsconfig 403

    @rx_awsfiles path_regexp (?i)/?(.*/)?aws.*\.(js|json|yml|yaml|txt|env|config)
    respond @rx_awsfiles 403

    # ========================
    # SECURITY HEADERS
    # ========================
    header {
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin"
    }

    # ========================
    # DEFAULT REVERSE PROXY
    # ========================
    @backend_ready expression `{env.BACKEND_HOST} != "" && {env.BACKEND_PORT} != ""`
    reverse_proxy @backend_ready {$BACKEND_HOST}:{$BACKEND_PORT}
    respond "Backend not configured. Set BACKEND_HOST and BACKEND_PORT." 503

}